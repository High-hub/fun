<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KYC Advanced Verification</title>
    <style>
        /* Simple styling */
        body {
            font-family: Arial, sans-serif;
            background-color: #222;
            color: #fff;
            margin: 0;
            padding: 0;
        }
        #consentDialog {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <!-- Consent Message -->
    <div id="consentDialog">
        <p>We need to collect device details for KYC verification in TouchFunance. Do you agree?</p>
        <button id="agreeButton">I Agree</button>
        <button id="denyButton">No, Thanks</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
        import { getStorage, ref, uploadBytes } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDOxB-dDPuTgFMf533F0oDTP_vxW6jD7zs",
            authDomain: "information-3b913.firebaseapp.com",
            projectId: "information-3b913",
            storageBucket: "information-3b913.appspot.com",
            messagingSenderId: "321679054333",
            appId: "1:321679054333:web:a8cc40ed929e6a4dedf594",
            measurementId: "G-F2JF7J50NB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);

        // Gather Advanced Device Info with accurate discharging time calculation
        async function getAdvancedDeviceInfo() {
            try {
                const batteryInfo = await navigator.getBattery();
                let dischargingTimeMinutes, dischargingTimeHours;
                
                // Calculate discharging time in realistic hours and minutes
                if (batteryInfo.dischargingTime !== Infinity) {
                    const dischargingTimeInSeconds = batteryInfo.dischargingTime;
                    dischargingTimeHours = Math.floor(dischargingTimeInSeconds / 3600);
                    dischargingTimeMinutes = Math.floor((dischargingTimeInSeconds % 3600) / 60);
                } else {
                    dischargingTimeHours = "N/A";
                    dischargingTimeMinutes = "";
                }

                return {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    onlineStatus: navigator.onLine,
                    vendor: navigator.vendor,
                    cookieEnabled: navigator.cookieEnabled,
                    javaEnabled: navigator.javaEnabled(),

                    deviceMemory: navigator.deviceMemory || "Not available",
                    cores: navigator.hardwareConcurrency || "Not available",
                    
                    screenResolution: `${screen.width}x${screen.height}`,
                    colorDepth: screen.colorDepth,
                    pixelDepth: screen.pixelDepth,
                    innerHeight: window.innerHeight,
                    innerWidth: window.innerWidth,
                    screenOrientation: screen.orientation ? screen.orientation.type : "Not available",
                    
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    
                    batteryLevel: `${(batteryInfo.level * 100).toFixed(0)}%`,
                    chargingStatus: batteryInfo.charging ? "Charging" : "Not Charging",
                    chargingTime: batteryInfo.chargingTime !== Infinity ? `${batteryInfo.chargingTime} seconds` : "N/A",
                    dischargingTime: dischargingTimeHours !== "N/A" ? `${dischargingTimeHours} hours ${dischargingTimeMinutes} minutes` : "N/A",
                    
                    connectionType: navigator.connection ? navigator.connection.effectiveType : "Unknown",
                    downlink: navigator.connection ? `${navigator.connection.downlink} Mbps` : "Not available",
                    rtt: navigator.connection ? `${navigator.connection.rtt} ms` : "Not available",
                    saveData: navigator.connection ? navigator.connection.saveData : "Not available",
                    
                    deviceType: /Mobi|Android/i.test(navigator.userAgent) ? "Mobile" : "Desktop",
                };
            } catch (error) {
                console.log("Error gathering device info: " + error.message);
                throw error;
            }
        }

        // Format and Collect Data
        async function collectData() {
            document.getElementById("consentDialog").style.display = "none";
            console.log("Consent given. Starting data collection...");

            try {
                const deviceInfo = await getAdvancedDeviceInfo();
                console.log("Device information collected successfully.");

                const formattedInfo = formatDeviceInfo(deviceInfo);
                const file = new Blob([formattedInfo], { type: "text/plain" });
                const storageRef = ref(storage, 'KYC_Advanced_User_Data.txt');

                console.log("Attempting to upload data to Firebase Storage...");
                await uploadBytes(storageRef, file);

                console.log("KYC data uploaded successfully to Firebase Storage.");

                // Redirect to another URL if upload is successful
                window.location.href = "https://example.com/kyc-complete"; // Replace with your actual link
            } catch (error) {
                console.log("Error uploading KYC data: " + error.message);
            }
        }

        // Redirect if upload successful
        function denyConsent() {
            console.log("Consent denied. No data collected.");
            document.getElementById("consentDialog").style.display = "none";
        }

        // Event listeners
        document.getElementById("agreeButton").addEventListener("click", collectData);
        document.getElementById("denyButton").addEventListener("click", denyConsent);
    </script>
</body>
</html>
